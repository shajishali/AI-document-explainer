<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Detail - AI Legal Explainer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .risk-high { color: #dc3545; }
        .risk-medium { color: #ffc107; }
        .risk-low { color: #28a745; }
        .clause-card { margin-bottom: 1rem; }
        .processing-status { font-size: 0.9rem; }
        
        /* Detected Clauses Scrollable Container */
        .clauses-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .clauses-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .clauses-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .clauses-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .clauses-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Footer Styles */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        main {
            flex: 1;
        }
        
        footer {
            margin-top: auto;
            background-color: #f8f9fa !important;
            border-top: 1px solid #dee2e6;
        }
        
        .footer-content {
            padding: 1.5rem 0;
            color: #6c757d;
        }
        
        .footer-links {
            margin-bottom: 1rem;
        }
        
        .footer-links a {
            color: #6c757d;
            text-decoration: none;
            margin: 0 0.5rem;
            transition: color 0.3s ease;
        }
        
        .footer-links a:hover {
            color: #495057;
        }
        
        .footer-copyright {
            font-size: 0.9rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'main:welcome' %}">
                <i class="fas fa-balance-scale me-2"></i>
                AI Legal Explainer
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'main:home' %}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'main:glossary' %}">Glossary</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'main:upload_document' %}">Upload Document</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <div class="container mt-5">
        <!-- Main Content in Two Columns -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
                <!-- Document Header -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            {{ document.title }}
                        </h5>
                        <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteDocument('{{ document.id }}', '{{ document.title }}')">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                    <div class="card-body">
                        <p><strong>Type:</strong> {{ document.get_document_type_display }}</p>
                        <p><strong>Uploaded:</strong> {{ document.uploaded_at|date:"F j, Y, g:i a" }}</p>
                        <p><strong>File Size:</strong> {{ document.file_size|filesizeformat }}</p>
                        <p><strong>Status:</strong> 
                            {% if document.is_processed %}
                                <span class="badge bg-success">Processed</span>
                            {% else %}
                                <span class="badge bg-warning">Processing</span>
                            {% endif %}
                        </p>
                        <p><strong>File:</strong> <a href="{{ document.file.url }}" target="_blank">{{ document.file.name }}</a></p>
                        {% if document.processed_at %}
                            <p><strong>Processed:</strong> {{ document.processed_at|date:"F j, Y, g:i a" }}</p>
                        {% endif %}
                        {% if document.clauses.count > 0 %}
                            <p><strong>Clauses Detected:</strong> {{ document.clauses.count }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Processing Status -->
                {% if document.processing_logs.all %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            Processing Status
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for log in document.processing_logs.all %}
                        <div class="processing-status mb-2">
                            <strong>{{ log.get_step_display }}:</strong>
                            {% if log.status == 'completed' %}
                                <span class="badge bg-success">{{ log.get_status_display }}</span>
                            {% elif log.status == 'processing' %}
                                <span class="badge bg-warning">{{ log.get_status_display }}</span>
                            {% elif log.status == 'failed' %}
                                <span class="badge bg-danger">{{ log.get_status_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ log.get_status_display }}</span>
                            {% endif %}
                            {% if log.completed_at %}
                                <br><small>{{ log.completed_at|date:"g:i:s" }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Document Summary -->
                {% if document.summary %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-file-text me-2"></i>
                            AI-Generated Summary
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6>Plain Language Summary:</h6>
                        <p>{{ document.summary.plain_language_summary }}</p>
                        
                        {% if document.summary.legal_summary %}
                        <h6>Legal Summary:</h6>
                        <p>{{ document.summary.legal_summary }}</p>
                        {% endif %}
                        
                        {% if document.summary.key_points %}
                        <h6>Key Points:</h6>
                        <ul>
                            {% for point in document.summary.key_points %}
                            <li>{{ point }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        
                        <p class="text-muted">
                            <small>Generated on {{ document.summary.generated_at|date:"F j, Y, g:i a" }} | 
                            {{ document.summary.word_count }} words</small>
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Column -->
            <div class="col-md-6">
                <!-- Risk Analysis -->
                {% if document.risk_analysis %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Risk Analysis
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6>Overall Risk Level:</h6>
                        <p>
                            <span class="badge {% if document.risk_analysis.overall_risk_level == 'high' %}bg-danger{% elif document.risk_analysis.overall_risk_level == 'medium' %}bg-warning{% else %}bg-success{% endif %} fs-6">
                                {{ document.risk_analysis.get_overall_risk_level_display }}
                            </span>
                            (Score: {{ document.risk_analysis.overall_risk_score|floatformat:2 }})
                        </p>
                        
                        <h6>Risk Breakdown:</h6>
                        <ul class="list-unstyled">
                            <li><span class="risk-high">ðŸ”´</span> High Risk: {{ document.risk_analysis.high_risk_clauses_count }}</li>
                            <li><span class="risk-medium">ðŸŸ </span> Medium Risk: {{ document.risk_analysis.medium_risk_clauses_count }}</li>
                            <li><span class="risk-low">ðŸŸ¢</span> Low Risk: {{ document.risk_analysis.low_risk_clauses_count }}</li>
                        </ul>
                        
                        <h6>Analysis Summary:</h6>
                        <p>{{ document.risk_analysis.analysis_summary }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- Detected Clauses -->
                {% if document.clauses.all %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-search me-2"></i>
                            Detected Clauses
                        </h6>
                    </div>
                    <div class="card-body clauses-container">
                        {% for clause in document.clauses.all %}
                        <div class="clause-card card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6 class="card-title">{{ clause.get_clause_type_display }}</h6>
                                        <p class="card-text"><strong>Text:</strong> {{ clause.original_text|truncatewords:30 }}</p>
                                        {% if clause.plain_language_summary %}
                                        <p class="card-text"><strong>Explanation:</strong> {{ clause.plain_language_summary }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="badge {% if clause.risk_level == 'high' %}bg-danger{% elif clause.risk_level == 'medium' %}bg-warning{% else %}bg-success{% endif %} fs-6">
                                            {{ clause.get_risk_level_display }} Risk
                                        </span>
                                        <br>
                                        <small class="text-muted">Score: {{ clause.risk_score|floatformat:2 }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Document Text -->
                {% if document.processed_text %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-align-left me-2"></i>
                            Processed Document Text
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="border p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                            <pre style="white-space: pre-wrap; font-family: inherit;">{{ document.processed_text|truncatewords:300 }}</pre>
                        </div>
                        {% if document.processed_text|wordcount > 300 %}
                        <p class="text-muted mt-2">
                            <small>Showing first 300 words. Full text available in database.</small>
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="row mt-4 mb-5">
            <div class="col-12 text-center">
                <!-- Enhanced Functionality Links -->
                {% if document.clauses.all %}
                <div class="mb-3">
                    <h6 class="text-muted mb-3">Enhanced Analysis Tools</h6>
                    <div class="d-flex justify-content-center flex-wrap gap-2">
                        <a href="{% url 'main:risk_dashboard' document.id %}" class="btn btn-info">
                            <i class="fas fa-chart-pie me-2"></i>
                            Risk Dashboard
                        </a>
                        <a href="{% url 'main:clause_library' %}" class="btn btn-warning">
                            <i class="fas fa-book me-2"></i>
                            Clause Library
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <!-- What-If Simulation Links for High-Risk Clauses -->
                {% if document.clauses.all %}
                <div class="mb-3">
                    <h6 class="text-muted mb-3">What-If Simulations</h6>
                    <div class="d-flex justify-content-center flex-wrap gap-2">
                        {% for clause in document.clauses.all %}
                            {% if clause.risk_level == 'high' %}
                            <a href="{% url 'main:what_if_simulation' clause.id %}" class="btn btn-danger btn-sm">
                                <i class="fas fa-play me-1"></i>
                                Simulate {{ clause.get_clause_type_display }}
                            </a>
                            {% endif %}
                        {% endfor %}
                        {% if not document.clauses.all|dictsort:"risk_level"|first|slice:":1" == "high" %}
                            <span class="text-muted">No high-risk clauses for simulation</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Standard Actions -->
                <div class="mb-3">
                    <a href="{% url 'main:upload_document' %}" class="btn btn-primary me-2">
                        <i class="fas fa-upload me-2"></i>
                        Upload Another Document
                    </a>
                    <a href="{% url 'main:home' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-home me-2"></i>
                        Back to Home
                    </a>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="footer-content">
                <!-- Footer Links -->
                <div class="footer-links text-center">
                    <a href="{% url 'main:home' %}">
                        <i class="fas fa-home me-1"></i>Home
                    </a>
                    <a href="{% url 'main:upload_document' %}">
                        <i class="fas fa-upload me-1"></i>Upload
                    </a>
                    <a href="{% url 'main:glossary' %}">
                        <i class="fas fa-book me-1"></i>Glossary
                    </a>
                    <a href="{% url 'main:clause_library' %}">
                        <i class="fas fa-book me-1"></i>Clause Library
                    </a>
                    <a href="{% url 'main:language_switcher' %}">
                        <i class="fas fa-globe me-1"></i>Languages
                    </a>
                </div>
                
                <!-- Footer Divider -->
                <hr class="my-3" style="border-color: #dee2e6;">
                
                <!-- Footer Info -->
                <div class="row text-center">
                    <div class="col-md-4">
                        <h6 class="text-dark mb-2">
                            <i class="fas fa-balance-scale me-2"></i>AI Legal Explainer
                        </h6>
                        <p class="small text-muted mb-0">Advanced AI-powered legal document analysis</p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-dark mb-2">
                            <i class="fas fa-language me-2"></i>Multilingual Support
                        </h6>
                        <p class="small text-muted mb-0">English â€¢ Tamil â€¢ Sinhala</p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-dark mb-2">
                            <i class="fas fa-shield-alt me-2"></i>Features
                        </h6>
                        <p class="small text-muted mb-0">Risk Analysis â€¢ What-If Simulation â€¢ Clause Library</p>
                    </div>
                </div>
                
                                 <!-- Copyright -->
                 <div class="text-center mt-3">
                     <p class="footer-copyright mb-0">
                         &copy; 2024 AI Legal Explainer. All rights reserved.
                     </p>
                 </div>
            </div>
        </div>
    </footer>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the document <strong id="deleteDocumentTitle"></strong>?</p>
                    <p class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        This action will permanently delete:
                    </p>
                    <ul class="text-muted small">
                        <li>The document file</li>
                        <li>All extracted text and analysis</li>
                        <li>Detected clauses and risk assessment</li>
                        <li>Processing logs and summaries</li>
                    </ul>
                    <p class="text-danger fw-bold">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteDocument()">
                        <i class="fas fa-trash me-1"></i>Delete Document
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSRF Token (hidden) -->
    {% csrf_token %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Delete document functions
        let documentToDelete = null;

        function confirmDeleteDocument(documentId, documentTitle) {
            documentToDelete = documentId;
            document.getElementById('deleteDocumentTitle').textContent = documentTitle;
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        async function deleteDocument() {
            if (!documentToDelete) {
                console.error('No document selected for deletion');
                return;
            }

            try {
                // Show loading state
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
                confirmBtn.disabled = true;

                // Get CSRF token
                let csrfToken = '';
                const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfElement) {
                    csrfToken = csrfElement.value;
                } else {
                    // Fallback: try to get from cookie
                    csrfToken = getCookie('csrftoken');
                }
                
                if (!csrfToken) {
                    throw new Error('CSRF token not found');
                }

                // Make DELETE request
                const response = await fetch(`/api/documents/${documentToDelete}/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    }
                });

                if (response.ok) {
                    // Close modal
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    deleteModal.hide();
                    
                    // Show success message and redirect
                    alert('Document deleted successfully!');
                    window.location.href = "{% url 'main:home' %}";
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete document');
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                alert(`Error deleting document: ${error.message}`);
            } finally {
                // Reset button state
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }

        // Utility function to get cookie value
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>

